<!DOCTYPE html>
<html>
<head>
    <title>Chat System</title>
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
</head>
<body>
    <h1>Welcome to the Chat System</h1>
    <p>This is a simple chat application interface.</p>

    <label for="usernameInput"></label><input type="text" id="usernameInput" placeholder="Enter your username" />
    <label for="messageInput"></label><input type="text" id="messageInput" placeholder="Type your message here..." />

    <button id="sendButton">Send</button>

    <div id="messageArea"></div>

    <script>
        let stompClient = null;
        let username = '';

        const usernameInput = document.getElementById('usernameInput');
        const messageInput = document.getElementById('messageInput');
        const sendButton = document.getElementById('sendButton');
        const messageArea = document.getElementById('messageArea');

        function connect() {
            // 1. Connect to WebSocket
            const socket = new SockJS('/ws-chat');
            stompClient = Stomp.over(socket);

            // 2. On connect, subscribe to topic
            stompClient.connect({}, function(frame) {
                console.log('Connected to chat: ' + frame);

                stompClient.subscribe('/topic/public', function(message) {
                    // Display received message
                    showMessage(JSON.parse(message.body));
                });
            }, function(error) {
                console.error('STOMP error: ' + error);
                setTimeout(connect, 5000); // Reconnect after 5 seconds
            });
        }

        function showMessage(message) {
            const messageElement = document.createElement('div');
            messageElement.textContent = `[${message.type}] ${message.sender}: ${message.content}`;
            messageArea.appendChild(messageElement);
            console.log('Received:', message);
        }

        function sendMessage() {
            if (!username) {
                username = usernameInput.value.trim();
                if (!username) {
                    alert('Please enter a username');
                    return;
                }

                // Send JOIN message
                const joinMessage = {
                    type: 'JOIN',
                    sender: username,
                    content: username + ' joined the chat',
                    timestamp: new Date().toISOString()
                };
                stompClient.send("/app/chat.send", {}, JSON.stringify(joinMessage));
                usernameInput.disabled = true;
                return;
            }

            // 3. Send CHAT message
            const content = messageInput.value.trim();
            if (content && stompClient && stompClient.connected) {
                const chatMessage = {
                    type: 'CHAT',
                    sender: username,
                    content: content,
                    timestamp: new Date().toISOString()
                };
                stompClient.send("/app/chat.send", {}, JSON.stringify(chatMessage));
                messageInput.value = '';
            }
        }

        sendButton.addEventListener('click', sendMessage);
        messageInput.addEventListener('keypress', function(event) {
            if (event.key === 'Enter') {
                sendMessage();
            }
        });

        window.addEventListener('beforeunload', function() {
            if (stompClient && username) {
                const leaveMessage = {
                    type: 'LEAVE',
                    sender: username,
                    content: username + ' left the chat',
                    timestamp: new Date().toISOString()
                };
                stompClient.send("/app/chat.send", {}, JSON.stringify(leaveMessage));
                stompClient.disconnect();
            }
        });

        connect();
    </script>


</body>
</html>
